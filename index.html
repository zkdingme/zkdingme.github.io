<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
   
  <meta name="keywords" content="丁星乐、学习、工作、生活" />
   
  <meta name="description" content="分享丁星乐的学习、工作与享乐时光" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>
     丁星乐
  </title>
  <meta name="generator" content="hexo-theme-yilia-plus">
  
  <link rel="shortcut icon" href="/favicon.ico" />
  
  
<link rel="stylesheet" href="/css/style.css">

  
<script src="/js/pace.min.js"></script>


  

  

</head>

</html>

<body>
  <div id="app">
    <main class="content">
      
<section class="cover">
    
      
      <a class="forkMe" href="https://github.com/dingzhenkai"
        target="_blank"><img width="149" height="149" src="/images/forkme.png"
          class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/cover.jpg" alt="image frame" />
    </div>
    <div style="color:#000" class="cover-inner text-center text-white">
      <h1><a style="color:#000" href="/">丁星乐</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>


<div id="main">
  <section class="outer">
  <article class="articles">
    
    
    
    
    <article id="post-elf-format" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/07/14/elf-format/"
    >elf 格式简介</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/07/14/elf-format/" class="article-date">
  <time datetime="2021-07-14T11:23:49.000Z" itemprop="datePublished">2021-07-14</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h2 id="1-elf是什么"><a href="#1-elf是什么" class="headerlink" title="1. elf是什么"></a>1. elf是什么</h2><p>维基百科介绍如下：</p>
<blockquote>
<p><strong>可执行与可链接格式</strong> （英语：Executable and Linkable Format，缩写为ELF），常被称为<strong>ELF格式</strong>，在<a href="https://zh.wikipedia.org/wiki/電腦科學" target="_blank" rel="noopener">计算机科学</a>中，是一种用于<a href="https://zh.wikipedia.org/wiki/執行檔" target="_blank" rel="noopener">可执行文件</a>、<a href="https://zh.wikipedia.org/wiki/目的檔" target="_blank" rel="noopener">目标文件</a>、<a href="https://zh.wikipedia.org/wiki/共享库" target="_blank" rel="noopener">共享库</a>和核心转储(core dump)的标准<a href="https://zh.wikipedia.org/wiki/檔案格式" target="_blank" rel="noopener">文件格式</a>。</p>
</blockquote>
<p>Linux 中</p>
<p>例如Linux中可执行文件ls, grep之类的，或者共享库libc.so 都是elf格式。</p>
<h2 id="2-elf文件格式是什么样的，有图吗"><a href="#2-elf文件格式是什么样的，有图吗" class="headerlink" title="2. elf文件格式是什么样的，有图吗"></a>2. elf文件格式是什么样的，有图吗</h2><p><img src="/Users/dingzhenkai/Documents/JSProj/blog/source/_posts/elf-format/elf-format.png" alt=""></p>
<ul>
<li><p>ELF header：在文件的开始，描述整个文件的组织。</p>
</li>
<li><p>Program header table：告诉系统如何创建进程映像。用来构造进程映像的目标文件必须具有程序头部表，可重定位文件不需要这个表。</p>
</li>
<li><p>Section header table ：包含了描述文件节区的信息，每个节区在表中都有一项，每一项给出诸如节区名称、节区大小这类信息。用于链接的目标文件必须包含节区头部表，其他目标文件可以有，也可以没有这个表。</p>
</li>
<li><p>sections 或者 segments：segments是从运行的角度来描述elf文件，sections是从链接的角度来描述elf文件，也就是说，在链接阶段，我们可以忽略program header table来处理此文件，在运行阶段可以忽略section header table来处理此程序（所以很多加固手段删除了section header table）。注意：segments与sections是包含的关系，一个segment包含若干个section。</p>
</li>
</ul>
<p><strong>Section 有哪些</strong></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//main.cpp </span></span><br><span class="line"><span class="keyword">int</span> a = <span class="number">0</span>; <span class="comment">// .data</span></span><br><span class="line"><span class="keyword">char</span> *p1; <span class="comment">// .bss</span></span><br><span class="line">main() </span><br><span class="line">&#123; </span><br><span class="line"><span class="keyword">int</span> b; <span class="comment">// 栈</span></span><br><span class="line"><span class="keyword">char</span> s[] = <span class="string">"abc"</span>; <span class="comment">// 栈</span></span><br><span class="line"><span class="keyword">char</span> *p2; <span class="comment">// 栈</span></span><br><span class="line"><span class="keyword">char</span> *p3 = <span class="string">"123456"</span>; <span class="comment">// p3 在栈上, "123456" 在 rodata</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> c =<span class="number">0</span>； <span class="comment">// .data</span></span><br><span class="line">p1 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">10</span>); </span><br><span class="line">p2 = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">20</span>); </span><br><span class="line"><span class="comment">// 分配得来得10和20字节的区域就在堆区。 </span></span><br><span class="line"><span class="built_in">strcpy</span>(p1, <span class="string">"123456"</span>); <span class="comment">// 123456放在常量区，编译器可能会将它与p3所指向的"123456"优化成一个地方。 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ul>
<li><p>.bss </p>
<p>未初始化的全局变量和静态变量，初始化为0的全局变量和静态变量也在.bss，如果数据全是零，为了优化考虑，编译器把它当作bss处理</p>
<p>.bss 段不占elf文件空间，其内容由操作系统初始化，统一初始化为0 .bss类型的全局变量只占运行时的内存空间，而不占文件空间</p>
</li>
<li><p>.comment </p>
<p>一些版本信息</p>
</li>
<li><p>.data .data1 </p>
<p>静态初始化(非零)的数据，所以有初值的全局变量和static变量在data区</p>
</li>
<li><p>.debug </p>
</li>
<li><p>.dynamic </p>
</li>
<li><p>.dynstr </p>
</li>
<li><p>.dynsym </p>
</li>
<li><p>.fini </p>
</li>
<li><p>.got </p>
<p>外部变量引用的地址</p>
</li>
<li><p>.hash </p>
</li>
<li><p>.init </p>
</li>
<li><p>.interp </p>
</li>
<li><p>.line </p>
</li>
<li><p>.note </p>
</li>
<li><p>.plt </p>
</li>
<li><p>.plt.got</p>
<p>外部函数引用的地址</p>
<p><a href="https://gtoad.github.io/2018/07/05/Android-Native-Hook/" target="_blank" rel="noopener">https://gtoad.github.io/2018/07/05/Android-Native-Hook/</a></p>
</li>
<li><p>.relname</p>
</li>
<li><p>.relaname </p>
</li>
<li><p>.rodata .rodata1 </p>
<p>存放常量</p>
<p>用const修饰的变量放在 rodata 里，字符串默认就是常量, #define定义的常量</p>
<p>const修饰的全局变量在常量区；const修饰的局部变量只是为了防止修改，没有放入常量区</p>
<p><a href="https://blog.csdn.net/laiqun_ai/article/details/8528366" target="_blank" rel="noopener">https://blog.csdn.net/laiqun_ai/article/details/8528366</a></p>
</li>
<li><p>.shstrtab </p>
</li>
<li><p>.strtab </p>
</li>
<li><p>.symtab </p>
</li>
<li><p>.text</p>
<p>代码</p>
</li>
</ul>
<p>参考： <a href="https://refspecs.linuxfoundation.org/elf/elf.pdf" target="_blank" rel="noopener">https://refspecs.linuxfoundation.org/elf/elf.pdf</a></p>
<p><a href="https://bbs.pediy.com/thread-259901.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-259901.htm</a></p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2021/07/14/elf-format/" data-id="ckrlualr50035xcj50xa3bvzq"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/elf/" rel="tag">elf</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-android-uid" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/07/11/android-uid/"
    >android uid介绍</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/07/11/android-uid/" class="article-date">
  <time datetime="2021-07-11T09:46:40.000Z" itemprop="datePublished">2021-07-11</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h2 id="uid-是什么"><a href="#uid-是什么" class="headerlink" title="uid 是什么"></a>uid 是什么</h2><p>android中uid用于标识一个应用程序，uid在应用安装时被分配，并且在应用存在于手机上期间，都不会改变。一个应用程序只能有一个uid，多个应用可以使用sharedUserId 方式共享同一个uid，前提是这些应用的签名要相同。</p>
<h2 id="uid-怎么生成的"><a href="#uid-怎么生成的" class="headerlink" title="uid 怎么生成的"></a>uid 怎么生成的</h2><p>uid是在app安装的时候分配的，关键代码如下：</p>
<p><strong>以下代码来自android-10.0.0_r1</strong></p>
<p>首先是在<a href="https://cs.android.com/android/platform/superproject/+/android-10.0.0_r1:frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java" target="_blank" rel="noopener">PMS</a>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Prepares the system to commit a &#123;<span class="doctag">@link</span> ScanResult&#125; in a way that will not fail by registering</span></span><br><span class="line"><span class="comment"> * the app ID required for reconcile.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if a new app ID was registered and will need to be cleaned up on</span></span><br><span class="line"><span class="comment"> *         failure.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">optimisticallyRegisterAppId</span><span class="params">(@NonNull ScanResult result)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!result.existingSettingCopied) &#123;</span><br><span class="line">        <span class="comment">// THROWS: when we can't allocate a user id. add call to check if there's</span></span><br><span class="line">        <span class="comment">// enough space to ensure we won't throw; otherwise, don't modify state</span></span><br><span class="line">        <span class="comment">// 这里注册新的app id，也就是uid</span></span><br><span class="line">        <span class="keyword">return</span> mSettings.registerAppIdLPw(result.pkgSetting);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<a href="https://cs.android.com/android/platform/superproject/+/android-10.0.0_r1:frameworks/base/services/core/java/com/android/server/pm/Settings.java" target="_blank" rel="noopener">Settings</a>中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers a user ID with the system. Potentially allocates a new user ID.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if a new app ID was created in the process. &#123;<span class="doctag">@code</span> false&#125; can be</span></span><br><span class="line"><span class="comment"> *         returned in the case that a shared user ID already exists or the explicit app ID is</span></span><br><span class="line"><span class="comment"> *         already registered.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> PackageManagerException If a user ID could not be allocated.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">registerAppIdLPw</span><span class="params">(PackageSetting p)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> createdNew;</span><br><span class="line">    <span class="keyword">if</span> (p.appId == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Assign new user ID</span></span><br><span class="line">        <span class="comment">// 这里注册新uid</span></span><br><span class="line">        p.appId = acquireAndRegisterNewAppIdLPw(p);</span><br><span class="line">        createdNew = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Add new setting to list of user IDs</span></span><br><span class="line">        createdNew = registerExistingAppIdLPw(p.appId, p, p.name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (p.appId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        PackageManagerService.reportSettingsProblem(Log.WARN,</span><br><span class="line">                <span class="string">"Package "</span> + p.name + <span class="string">" could not be assigned a valid UID"</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_INSUFFICIENT_STORAGE,</span><br><span class="line">                <span class="string">"Package "</span> + p.name + <span class="string">" could not be assigned a valid UID"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> createdNew;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** Returns a new AppID or -1 if we could not find an available AppID to assign */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">acquireAndRegisterNewAppIdLPw</span><span class="params">(SettingBase obj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Let's be stupidly inefficient for now...</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = mAppIds.size();</span><br><span class="line">    <span class="comment">// mFirstAvailableUid下面我会详细解释，这里可以简单理解为最近被卸载的app的uid</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = mFirstAvailableUid; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="comment">// 首先看已经分配过的uid中有没有被释放的</span></span><br><span class="line">        <span class="comment">// 找到第一个可用的uid，返回</span></span><br><span class="line">        <span class="keyword">if</span> (mAppIds.get(i) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            mAppIds.set(i, obj);</span><br><span class="line">            <span class="comment">// 这里 FIRST_APPLICATION_UID = 10000;</span></span><br><span class="line">            <span class="keyword">return</span> Process.FIRST_APPLICATION_UID + i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// None left?</span></span><br><span class="line">    <span class="comment">// 这里LAST_APPLICATION_UID = 19999</span></span><br><span class="line">    <span class="comment">// 所以最多安装9999个app</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt; (Process.LAST_APPLICATION_UID - Process.FIRST_APPLICATION_UID)) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 已经分配的uid中没有被释放的，新分配一个</span></span><br><span class="line">    mAppIds.add(obj);</span><br><span class="line">    <span class="keyword">return</span> Process.FIRST_APPLICATION_UID + size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们解释一下mFirstAvailableUid，Settings中相关代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 每次重启时会重新赋值为0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> mFirstAvailableUid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This should be called (at least) whenever an application is removed</span></span><br><span class="line"><span class="comment">// 每次卸载时会被调用</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setFirstAvailableUid</span><span class="params">(<span class="keyword">int</span> uid)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (uid &gt; mFirstAvailableUid) &#123;</span><br><span class="line">        mFirstAvailableUid = uid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到mFirstAvailableUid，初始化是0，之后每次有app卸载，对应uid被释放，mFirstAvailableUid就会被赋值为Math.max(mFirstAvailableUid, uid)。所以可以看到上面的循环从mFirstAvailableUid开始是做的一个小优化，希望循环次数少一点。但是也有缺陷，因为在不重启的情况下，mFirstAvailableUid一直是自增的，即使之前有被释放的uid，也访问不到，所以最坏情况就是每次都找不到可复用的uid，每次都分配新的uid，最终uid &gt; 19999，炸了，就不能安装app了。</p>
<h2 id="怎么获取uid"><a href="#怎么获取uid" class="headerlink" title="怎么获取uid"></a>怎么获取uid</h2><ul>
<li>ApplicationInfo.uid</li>
<li>Process.myuid() </li>
</ul>
<h2 id="uid-用来做什么"><a href="#uid-用来做什么" class="headerlink" title="uid 用来做什么"></a>uid 用来做什么</h2><p>权限控制，这里有空详细写一下</p>
<p>参考：<a href="https://www.jianshu.com/p/b33dd49f2ae6" target="_blank" rel="noopener">https://www.jianshu.com/p/b33dd49f2ae6</a></p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2021/07/11/android-uid/" data-id="ckrlualpz001gxcj5fvqs4edi"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/did/" rel="tag">did</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-TEE-kiss" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/07/11/TEE-kiss/"
    >Android TEE 介绍与使用</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/07/11/TEE-kiss/" class="article-date">
  <time datetime="2021-07-11T09:18:30.000Z" itemprop="datePublished">2021-07-11</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><img src="tee_arch.png" alt=""><br>来源： <a href="https://pdfs.semanticscholar.org/4643/cf6081b98f88736c94220ced13e5ad3569fc.pdf" target="_blank" rel="noopener">https://pdfs.semanticscholar.org/4643/cf6081b98f88736c94220ced13e5ad3569fc.pdf</a></p>
<p><strong>为什么需要TEE</strong></p>
<p>考虑这么一个问题：设备解锁的PIN码和指纹存储在哪里？Linux中，一切都是文件。如果指纹和PIN码存储在Android文件系统里面，只要攻击者获取ROOT权限，就可以读取指纹和PIN码，很不安全。</p>
<p>这种场景就需要TEE了。TEE是一套独立的文件系统，使用的是SoC一块独立的区域，可以理解为Android文件系统和TEE之间相互隔离。因此如果把PIN码和指纹存储在TEE中，Android文件系统是访问不到的，因此安全。</p>
<p>但这也带来了新的问题：</p>
<ul>
<li>PIN码验证和指纹验证是Android在做，Android如何在不能读取PIN码和指纹的情况下做验证？</li>
<li>既然TEE也是个文件系统，黑客可不可以直接开机进入TEE，拿到PIN码和指纹</li>
</ul>
<p>对于第二个问题，笔者无法解答，这里留个TODO。不过<a href="https://www.anquanke.com/post/id/236483#h2-7" target="_blank" rel="noopener">这篇文章</a>介绍了如何在获取Android ROOT权限的情况下攻陷TEE，拿到数据。</p>
<p>对于第一个问题，如上图所示，可以看到Android和TEE之间是有通信渠道的。TEE Kernel会开放有限的入口给Android，Android可以把待验证的指纹和PIN通过接口传到TEE，TEE验证之后返回验证结果。存储在TEE中的数据不会出TEE。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>Android 封装了Keystore类来访问TEE。具体使用可以看<a href="https://developer.android.com/training/articles/keystore" target="_blank" rel="noopener">官网介绍</a>。</p>
<p>官网没讲的是TEE中密钥的持久化，这里介绍一下。</p>
<p>简单说，App在TEE中存储的密钥在App卸载时都会被清楚，除非App是系统应用(具有system uid)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://android.googlesource.com/platform/frameworks/base/+/android-9.0.0_r30/services/core/java/com/android/server/pm/PackageManagerService.java#18570 </span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">     * This method deletes the package from internal data structures. If the DONT_DELETE_DATA</span></span><br><span class="line"><span class="comment">     * flag is not set, the data directory is removed as well.</span></span><br><span class="line"><span class="comment">     * make sure this flag is set for partially installed apps. If not its meaningless to</span></span><br><span class="line"><span class="comment">     * delete a partially installed application.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// App 卸载的时候会执行这个函数</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removePackageDataLIF</span><span class="params">(PackageSetting ps, <span class="keyword">int</span>[] allUserHandles,</span></span></span><br><span class="line"><span class="function"><span class="params">            PackageRemovedInfo outInfo, <span class="keyword">int</span> flags, <span class="keyword">boolean</span> writeSettings)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">if</span> (removedAppId != -<span class="number">1</span>) &#123; </span><br><span class="line">            <span class="comment">// A user ID was deleted here. Go through all users and remove it</span></span><br><span class="line">            <span class="comment">// from KeyStore.</span></span><br><span class="line">            <span class="comment">// 这里清楚tee中的数据</span></span><br><span class="line">            removeKeystoreDataIfNeeded(UserHandle.USER_ALL, removedAppId);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Remove entries from the keystore daemon. Will only remove it if the</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> appId&#125; is valid.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeKeystoreDataIfNeeded</span><span class="params">(<span class="keyword">int</span> userId, <span class="keyword">int</span> appId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (appId &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> KeyStore keyStore = KeyStore.getInstance();</span><br><span class="line">        <span class="keyword">if</span> (keyStore != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (userId == UserHandle.USER_ALL) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> <span class="keyword">int</span> individual : sUserManager.getUserIds()) &#123;</span><br><span class="line">                    keyStore.clearUid(UserHandle.getUid(individual, appId));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                keyStore.clearUid(UserHandle.getUid(userId, appId));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Slog.w(TAG, <span class="string">"Could not contact keystore to clear entries for app id "</span> + appId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://android.googlesource.com/platform/system/security/+/android-9.0.0_r30/keystore/key_store_service.cpp#689</span></span><br><span class="line"><span class="function">Status <span class="title">KeyStoreService::clear_uid</span><span class="params">(<span class="keyword">int64_t</span> targetUid64, <span class="keyword">int32_t</span>* aidl_return)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uid_t</span> targetUid = getEffectiveUid(targetUid64);</span><br><span class="line">    <span class="keyword">if</span> (!checkBinderPermissionSelfOrSystem(P_CLEAR_UID, targetUid)) &#123;</span><br><span class="line">        *aidl_return = <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>&gt;(ResponseCode::PERMISSION_DENIED);</span><br><span class="line">        <span class="keyword">return</span> Status::ok();</span><br><span class="line">    &#125;</span><br><span class="line">    ALOGI(<span class="string">"clear_uid %"</span> PRId64, targetUid64);</span><br><span class="line">    mKeyStore-&gt;removeAllGrantsToUid(targetUid);</span><br><span class="line">    String8 prefix = String8::format(<span class="string">"%u_"</span>, targetUid);</span><br><span class="line">    Vector&lt;String16&gt; aliases;</span><br><span class="line">    <span class="keyword">if</span> (mKeyStore-&gt;<span class="built_in">list</span>(prefix, &amp;aliases, get_user_id(targetUid)) != ResponseCode::NO_ERROR) &#123;</span><br><span class="line">        *aidl_return = <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>&gt;(ResponseCode::SYSTEM_ERROR);</span><br><span class="line">        <span class="keyword">return</span> Status::ok();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 这里根据aliases删除key</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; aliases.size(); i++) &#123;</span><br><span class="line">        <span class="function">String8 <span class="title">name8</span><span class="params">(aliases[i])</span></span>;</span><br><span class="line">        <span class="function">String8 <span class="title">filename</span><span class="params">(mKeyStore-&gt;getKeyNameForUidWithDir(name8, targetUid, ::TYPE_ANY))</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (get_app_id(targetUid) == AID_SYSTEM) &#123;</span><br><span class="line">            Blob keyBlob;</span><br><span class="line">            ResponseCode responseCode =</span><br><span class="line">                mKeyStore-&gt;get(filename.<span class="built_in">string</span>(), &amp;keyBlob, ::TYPE_ANY, get_user_id(targetUid));</span><br><span class="line">            <span class="keyword">if</span> (responseCode == ResponseCode::NO_ERROR &amp;&amp; keyBlob.isCriticalToDeviceEncryption()) &#123;</span><br><span class="line">                <span class="comment">// Do not clear keys critical to device encryption under system uid.</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mKeyStore-&gt;del(filename.<span class="built_in">string</span>(), ::TYPE_ANY, get_user_id(targetUid));</span><br><span class="line">        <span class="comment">// del() will fail silently if no cached characteristics are present for this alias.</span></span><br><span class="line">        <span class="function">String8 <span class="title">chr_filename</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            mKeyStore-&gt;getKeyNameForUidWithDir(name8, targetUid, ::TYPE_KEY_CHARACTERISTICS))</span></span>;</span><br><span class="line">        mKeyStore-&gt;del(chr_filename.<span class="built_in">string</span>(), ::TYPE_KEY_CHARACTERISTICS, get_user_id(targetUid));</span><br><span class="line">    &#125;</span><br><span class="line">    *aidl_return = <span class="keyword">static_cast</span>&lt;<span class="keyword">int32_t</span>&gt;(ResponseCode::NO_ERROR);</span><br><span class="line">    <span class="keyword">return</span> Status::ok();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2021/07/11/TEE-kiss/" data-id="ckrlualpm000kxcj5drjv5ar4"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TEE/" rel="tag">TEE</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-android-file-format" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/07/07/android-file-format/"
    >简述Android文件格式</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/07/07/android-file-format/" class="article-date">
  <time datetime="2021-07-07T13:23:53.000Z" itemprop="datePublished">2021-07-07</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>APK, Bundle, DEX, ART, OAT, VDEX, jar, .etc 都是啥格式？</p>
<p>android 加载的类从哪里来的</p>
<p>lineage os的framework层为啥都是空的</p>
<h2 id="APK"><a href="#APK" class="headerlink" title="APK"></a>APK</h2><p>Android 安装包，其实是个压缩文件，把后缀.apk 改成 .zip后解压，目录如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">AndroidManifest.xml </span><br><span class="line">META-INF &#x2F;&#x2F; android签名文件</span><br><span class="line">assets &#x2F;&#x2F; 资源文件</span><br><span class="line">classes.dex &#x2F;&#x2F; java代码</span><br><span class="line">classes1.dex &#x2F;&#x2F; java 代码</span><br><span class="line">classes2.dex &#x2F;&#x2F; java 代码</span><br><span class="line">lib &#x2F;&#x2F; native层so文件</span><br><span class="line">res &#x2F;&#x2F; view相关资源文件</span><br><span class="line">resources.arsc &#x2F;&#x2F; 资源索引文件，由R.layout.main 具体定位到main的路径</span><br></pre></td></tr></table></figure>



<h2 id="Bundle"><a href="#Bundle" class="headerlink" title="Bundle"></a>Bundle</h2><p>Google提出的一种将App上传到Google Play的格式，与APK类似，是一个带有 .aab 扩展名的 zip 文件。对于不使用Google Play做应用分发的开发者来说，并不需要关注这个格式。</p>
<p><strong>Bundle与APK的关系？</strong></p>
<p>Bundle只是上传到Google Play的格式，用户下载的还是APK。由Bundle到APK的这一步由Google Play完成。</p>
<p><strong>为什么提出Bundle格式，有什么好处？</strong></p>
<p>最大的好处是降低apk文件的大小。例如开发者为了兼容碎片化的android设备，会在apk里面加入很多冗余的代码或文件。例如libxxx.so， 通常一个apk中就花包含armeabi, arm64和x86等多种格式，但对具体用户来说，他只会使用一个，其他的都用不上，这些冗余的so文件就会增大apk的体积。</p>
<p>Bundle包含了编译后的源码和资源文件，上传到Google Play之后，用户下载时，Google Play会根据用户设备类型打包bundle文件中对应的资源和代码成apk，下发给用户，可以降低包体积，也可以让开发者做出更多定制化的功能。</p>
<p><a href="https://conorlee.top/2019/03/27/Android-APP-Bundles-Introduction/" target="_blank" rel="noopener">这篇文篇</a>介绍Bundle很清楚。</p>
<h2 id="CLASS"><a href="#CLASS" class="headerlink" title="CLASS"></a>CLASS</h2><p>CLASS是JAVA文件被编译后的格式，也是JVM执行的的文件格式。CLASS是个二进制文件。</p>
<p><img src="/Users/dingzhenkai/Documents/JSProj/blog/source/_posts/android-file-format/class.png" alt=""></p>
<p>mac上可以用xxd -b xxx.class查看class文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">zkding:ttt dingzhenkai$ xxd -b LJ29.class </span><br><span class="line">00000000: 11001010 11111110 10111010 10111110 00000000 00000000  ......</span><br><span class="line">00000006: 00000000 00111000 00000000 00011110 00001010 00000000  .8....</span><br><span class="line">0000000c: 00000101 00000000 00010001 00001001 00000000 00010010  ......</span><br><span class="line">00000012: 00000000 00010011 00001010 00000000 00010100 00000000  ......</span><br><span class="line">00000018: 00010101 00000111 00000000 00010110 00000111 00000000  ......</span><br><span class="line">0000001e: 00010111 00000001 00000000 00000110 00111100 01101001  ....&lt;i</span><br><span class="line">00000024: 01101110 01101001 01110100 00111110 00000001 00000000  nit&gt;..</span><br><span class="line">0000002a: 00000011 00101000 00101001 01010110 00000001 00000000  .()V..</span><br><span class="line">00000030: 00000100 01000011 01101111 01100100 01100101 00000001  .Code.</span><br><span class="line">00000036: 00000000 00001111 01001100 01101001 01101110 01100101  ..Line</span><br><span class="line">0000003c: 01001110 01110101 01101101 01100010 01100101 01110010  Number</span><br><span class="line">00000042: 01010100 01100001 01100010 01101100 01100101 00000001  Table.</span><br><span class="line">00000048: 00000000 00001011 01110011 01110000 01101001 01110010  ..spir</span><br><span class="line">0000004e: 01100001 01101100 01001111 01110010 01100100 01100101  alOrde</span><br><span class="line">00000054: 01110010 00000001 00000000 00000111 00101000 01011011  r...([</span><br><span class="line">0000005a: 01011011 01001001 00101001 01011011 01001001 00000001  [I)[I.</span><br><span class="line">00000060: 00000000 00001101 01010011 01110100 01100001 01100011  ..Stac</span><br><span class="line">00000066: 01101011 01001101 01100001 01110000 01010100 01100001  kMapTa</span><br></pre></td></tr></table></figure>

<h2 id="JAR"><a href="#JAR" class="headerlink" title="JAR"></a>JAR</h2><p>.class集合</p>
<h2 id="DEX"><a href="#DEX" class="headerlink" title="DEX"></a>DEX</h2><p>.class集合</p>
<p>在Android平台上，当java程序编译成class后，使用dx工具将所有的class文件整合到一个dex文件，目的是其中各个类能够共享数据，在一定程度上降低了冗余，同时也是文件结构更加经凑，dex文件是传统jar文件大小的50%左右。</p>
<h2 id="VDEX"><a href="#VDEX" class="headerlink" title="VDEX"></a>VDEX</h2><p>google在android8.0新增加了vdex文件，其中包含 APK 的未压缩 DEX 代码，另外还有一些旨在加快验证速度的元数据。</p>
<p>VDEX 文件有助于提升软件更新的性能和用户体验。VDEX 文件会存储包含验证程序依赖项且经过预验证的 DEX 文件，以便 ART 在系统更新期间无需再次解压和验证 DEX 文件。无需执行任何操作，即可实现该功能。该功能默认处于启用状态。要停用该功能，请将 ART_ENABLE_VDEX 环境变量设为 false。</p>
<h2 id="ODEX"><a href="#ODEX" class="headerlink" title="ODEX"></a>ODEX</h2><p>全名Optimized DEX，即优化过的DEX。<br>Apk在安装(installer)时，就会进行验证和优化，目的是为了校验代码合法性及优化代码执行速度，验证和优化后，会产生ODEX文件，运行Apk的时候，直接加载ODEX，避免重复验证和优化，加快了Apk的响应时间。</p>
<p>注意：优化过程会根据不同设备上Dalvik虚拟机的版本、Framework库的不同等因素而不同。在一台设备上被优化过的ODEX文件，拷贝到另一台设备上不一定能够运行。</p>
<h2 id="ART"><a href="#ART" class="headerlink" title="ART"></a>ART</h2><p>.art是一些类/filed/方法，app启动直接map到内存，从odex中拆分出来的,art文件主要为了加快应用的对“热代码”的加载与缓存</p>
<h2 id="OAT"><a href="#OAT" class="headerlink" title="OAT"></a>OAT</h2><p>oat 文件是 ART 运行的文件，是一种ELF格式的二进制可运行文件，包含 DEX 文件和编译出的本地机器指令文件。因为 oat 文件包含 DEX 文件，因此比 ODEX 文件占用空间更大。</p>
<p>由于其在安装时打包在里面的classes.dex文件会被工具dex2oat翻译成本地机器指令，最终得到一个ELF格式的OAT文件，ART 加载 OAT 文件后不需要经过处理就可以直接运行，它没有了从字节码装换成机器码的过程，因此运行速度更快。</p>
<p><img src="https://img-blog.csdnimg.cn/20191021092126228.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2pvaG5XY2hldW5n,size_16,color_FFFFFF,t_70" alt=""></p>
<h2 id="Android-mk-Android-bp"><a href="#Android-mk-Android-bp" class="headerlink" title="Android.mk Android.bp"></a>Android.mk Android.bp</h2><p>参考：<a href="https://blog.csdn.net/johnWcheung/article/details/102657024" target="_blank" rel="noopener">https://blog.csdn.net/johnWcheung/article/details/102657024</a></p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2021/07/07/android-file-format/" data-id="ckrlualpw0016xcj52jn4dqhy"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/" rel="tag">文件格式</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-lineageos-build" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/07/06/lineageos-build/"
    >编译lineageOS过程中的注意点</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/07/06/lineageos-build/" class="article-date">
  <time datetime="2021-07-06T14:36:38.000Z" itemprop="datePublished">2021-07-06</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/android/">android</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>本文记录根据<a href="https://wiki.lineageos.org/devices/sagit/build" target="_blank" rel="noopener">官网教程</a>编译lineageos时遇到的一些坑。</p>
<h2 id="下载时用清华源"><a href="#下载时用清华源" class="headerlink" title="下载时用清华源"></a>下载时用清华源</h2><p>repo init时需要首先下载repo命令的包</p>
<p>repo init -u <a href="https://github.com/LineageOS/android.git" target="_blank" rel="noopener">https://github.com/LineageOS/android.git</a> -b lineage-15.1 </p>
<p>repo sync下载lineage os源码是也使用清华源，<a href="https://mirror.tuna.tsinghua.edu.cn/help/lineageOS/" target="_blank" rel="noopener">参考</a></p>
<p>注意同步源码时使用命令 repo sync -c -j8</p>
<h2 id="提取vendor"><a href="#提取vendor" class="headerlink" title="提取vendor"></a>提取vendor</h2><p><a href="https://wiki.lineageos.org/extracting_blobs_from_zips.html" target="_blank" rel="noopener">官网</a>提供了两种方式，一种是从真机中提取，另一种是从安装包中提取。建议用后者，这里需要找到一个靠谱的安装包，我当时想找的是lineageos 15.1的版本，这个版本官网已经下架了(似乎是官网没有很多钱支付带宽和存储)，所以去网上下载的，好几个包都没用。。。</p>
<h2 id="编译报错"><a href="#编译报错" class="headerlink" title="编译报错"></a>编译报错</h2><p><strong>Communication error with Jack server (35), try ‘jack-diagnose’ or see Jack server log</strong></p>
<p>jack server 通信问题，<a href="https://hex.ro/wp/blog/communication-error-with-jack-server-35-try-jack-diagnose-or-see-jack-server-log/" target="_blank" rel="noopener">参考</a></p>
<p>需要重启jack server</p>
<h2 id="刷机报错"><a href="#刷机报错" class="headerlink" title="刷机报错"></a>刷机报错</h2><p>刷机步骤:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastboot flash recovery recovery.img</span><br><span class="line">fastboot boot recovery.img</span><br><span class="line">fastboot sideload lineageos.zip</span><br></pre></td></tr></table></figure>

<p><strong>assert(xiaomi.verify_trustzone(“TZ.BF.4.0.6-00124”, “xxxxx”) == “1”) failed</strong></p>
<p>解压编译出的zip文件，在META-INF\com\google\android\updater-script 中删掉第二行assert，然后重新压缩为zip即可刷入</p>
<h2 id="使用过程中的报错"><a href="#使用过程中的报错" class="headerlink" title="使用过程中的报错"></a>使用过程中的报错</h2><p><strong>网络已连接但是不能访问</strong></p>
<p>其实不是真的不能联网。lineageos通过访问Google来验证网络连接，国内自然连不了Google。试试baidu应该就可以访问。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://gitpress.io/@drinko/%E7%BC%96%E8%AF%91%E7%AC%94%E8%AE%B0" target="_blank" rel="noopener">https://gitpress.io/@drinko/%E7%BC%96%E8%AF%91%E7%AC%94%E8%AE%B0</a></li>
<li><a href="https://www.jianshu.com/p/19cb9c08ee51" target="_blank" rel="noopener">https://www.jianshu.com/p/19cb9c08ee51</a></li>
<li><a href="https://hex.ro/wp/blog/communication-error-with-jack-server-35-try-jack-diagnose-or-see-jack-server-log/" target="_blank" rel="noopener">https://hex.ro/wp/blog/communication-error-with-jack-server-35-try-jack-diagnose-or-see-jack-server-log/</a></li>
</ol>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2021/07/06/lineageos-build/" data-id="ckrlualr50037xcj516fl1kjv"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/lineages/" rel="tag">lineages</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-nexus-flush-rom" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/06/29/nexus-flush-rom/"
    >刷机(nexus、samsung、xiaomi)</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/06/29/nexus-flush-rom/" class="article-date">
  <time datetime="2021-06-29T11:40:26.000Z" itemprop="datePublished">2021-06-29</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%88%B7%E6%9C%BA/">刷机</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h2 id="Nexus"><a href="#Nexus" class="headerlink" title="Nexus"></a>Nexus</h2><h3 id="刷入CM"><a href="#刷入CM" class="headerlink" title="刷入CM"></a>刷入CM</h3><p>我这里记录的是Nexus 7（flo）刷入<a href="https://twrp.me/asus/asusnexus72013wifi.html" target="_blank" rel="noopener">TWRP</a> 跟 <a href="http://androidhost.org/uYlcI" target="_blank" rel="noopener">CM13(Android 6.0)</a> 的步骤（注：下载时如果速度太慢，五个多小时那样，把有线网切换为wifi下载）。  </p>
<ol>
<li>刷入CM（adb push CM.zip sdcard/）<br>注：adb push/pull 如果显示”remote do not exists” 一般是权限不对 可以先 adb root， adb remount一下，然后再adb push， 如果还不行，就改一下sdcard的权限（chmod 777 sdcard， chmod 777 -R sdcard），如果还不行，请Google。</li>
<li>关机。  </li>
<li>同时按住电源键与音量减键进入bootloader模式。  </li>
<li>解锁（fastboot oem unlock）</li>
<li>刷入TWRP（fastboot flash recovery xxx.img），然后进入Recovery Mode（fastboot boot xxx.img）<br>注：windows上使用fastboot需要装<a href="https://developer.android.com/studio/run/win-usb.html" target="_blank" rel="noopener">驱动</a><br>   如果您刷了Twrp后进入recovery mode后机子一直显示的是启动的画面（中间是Google 下面是一把锁，那可能是因为你刷入的Twrp不符合你的手机类型，您需要找到对应你手机的Twrp版本，重新刷入（即回到第一步）</li>
<li>wipe。</li>
<li>install CM.zip</li>
</ol>
<h3 id="刷入官方镜像"><a href="#刷入官方镜像" class="headerlink" title="刷入官方镜像"></a>刷入官方镜像</h3><p>下载<a href="https://developers.google.com/android/images" target="_blank" rel="noopener">官方镜像</a>，解压运行脚本。这是<a href="https://blog.csdn.net/u012417380/article/details/72843185" target="_blank" rel="noopener">参考</a></p>
<h2 id="Samsung"><a href="#Samsung" class="headerlink" title="Samsung"></a>Samsung</h2><p>用odin刷入官方固件</p>
<h2 id="Xiaomi"><a href="#Xiaomi" class="headerlink" title="Xiaomi"></a>Xiaomi</h2><p>小米刷机有两种方式，其一类似三星提供了odin傻瓜式刷机，小米也提供了<a href="https://www.miui.com/shuaji-393.html" target="_blank" rel="noopener">MiFlush</a>来傻瓜式刷机；其二就是先刷recovery再卡刷rom，与nexus类似。</p>
<h2 id="救砖"><a href="#救砖" class="headerlink" title="救砖"></a>救砖</h2><p>用线刷大师救砖</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2021/06/29/nexus-flush-rom/" data-id="ckrlualr60039xcj528uw1c1p"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%B7%E6%9C%BA/" rel="tag">刷机</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-Android-JS-Debug" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/06/28/Android-JS-Debug/"
    >动态调试Android Webview中的JS</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/06/28/Android-JS-Debug/" class="article-date">
  <time datetime="2021-06-28T14:23:58.000Z" itemprop="datePublished">2021-06-28</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a> / <a class="article-category-link" href="/categories/Android/H5/">H5</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>Chrome提供了动态调试Webview中JS的功能，这里记录一下步骤。</p>
<h2 id="1-配置Demo-APK"><a href="#1-配置Demo-APK" class="headerlink" title="1. 配置Demo APK"></a>1. 配置Demo APK</h2><p>这里首先需要测试手机/平板/模拟器开启adb 调试。</p>
<ul>
<li><p>给apk加上网络访问权限</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.INTERNET"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.ACCESS_NETWORK_STATE"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加webview控件，并配置调试相关属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setJavaScriptEnabled(<span class="keyword">true</span>); <span class="comment">// 允许webview执行JS</span></span><br><span class="line">setWebContentsDebuggingEnabled(<span class="keyword">true</span>); <span class="comment">// 允许调试</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>webview load js</p>
<p>load js有两种方式，其一js文件放在本地，然后webview使用file协议读取(需要setAllowFileAccess(true))，其二是js放在远端，webview使用http/https协议读取。建议用本地读取的方式，因为远端调试的话，Android 9 (api level 28)开始就禁用http协议，而使用https需要申请证书，很麻烦。</p>
</li>
<li><p>打开app</p>
</li>
</ul>
<h2 id="2-使用Chrome-进行调试"><a href="#2-使用Chrome-进行调试" class="headerlink" title="2. 使用Chrome 进行调试"></a>2. 使用Chrome 进行调试</h2><p>chrome 访问 chrome://inspect/#devices</p>
<p><img src="1.png" alt=""></p>
<p>点击inspect即可进入调试window</p>
<p><img src="2.png" alt=""></p>
<p>之后就可以愉快的调试了</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2021/06/28/Android-JS-Debug/" data-id="ckrlualp70001xcj5ezub00ft"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JS/" rel="tag">JS</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/WebView/" rel="tag">WebView</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-vpn-proxy" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/06/15/vpn-proxy/"
    >VPN与代理的区别</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/06/15/vpn-proxy/" class="article-date">
  <time datetime="2021-06-15T02:47:48.000Z" itemprop="datePublished">2021-06-15</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%BD%91%E7%BB%9C/">网络</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p>VPN和PROXY的使用场景很类似，都是利用一个中间服务器转发流量访问某个客户端访问不了的服务。核心区别在于客户端与中间服务器之间的通信是走什么协议。PROXY一般走应用层协议HTTP/HTTPS/SOCKS等，VPN则走比较底层的像数据链路层PPTP和L2TP，网络层的IPSEC等。二者也有相同点，客户端的IP都被重写成中间服务器的IP。</p>
<p><img src="cross.png" alt=""></p>
<p>回顾经典的网络架构图</p>
<p><img src="OSI.png" alt=""></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://blog.z3ratu1.cn/HTTPS%E4%BB%A3%E7%90%86%E5%8E%9F%E7%90%86.html" target="_blank" rel="noopener">HTTPS代理原理</a></li>
<li><a href="https://lilywei739.github.io/2017/01/25/principle_for_http_https.html" target="_blank" rel="noopener">HTTP、HTTPS代理分析及原理</a></li>
<li><a href="https://medium.com/@thomas_summon/%E6%B5%85%E8%B0%88vpn-vps-proxy%E4%BB%A5%E5%8F%8Ashadowsocks%E4%B9%8B%E9%97%B4%E7%9A%84%E8%81%94%E7%B3%BB%E5%92%8C%E5%8C%BA%E5%88%AB-b0198f92db1b" target="_blank" rel="noopener">浅谈vpn、vps、Proxy以及shadowsocks之间的联系和区别</a></li>
</ol>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2021/06/15/vpn-proxy/" data-id="ckrlualrc003txcj5dx0d0dg4"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/VPN/" rel="tag">VPN</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%90%86/" rel="tag">代理</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-ssh-login-expect" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/05/18/ssh-login-expect/"
    >ssh_login_expect</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/05/18/ssh-login-expect/" class="article-date">
  <time datetime="2021-05-18T01:43:46.000Z" itemprop="datePublished">2021-05-18</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <h2 id="解决的问题-使用场景"><a href="#解决的问题-使用场景" class="headerlink" title="解决的问题/使用场景"></a>解决的问题/使用场景</h2><p>ssh每次登陆时都要输入用户名和密码，如果有跳板机，还要输入多次用户名和密码，太慢了。</p>
<p>因此可以用expect脚本来代替手动ssh过程。</p>
<h2 id="expect介绍"><a href="#expect介绍" class="headerlink" title="expect介绍"></a>expect介绍</h2><p>TODO</p>
<h2 id="脚本样例"><a href="#脚本样例" class="headerlink" title="脚本样例"></a>脚本样例</h2><h3 id="不使用跳板机"><a href="#不使用跳板机" class="headerlink" title="不使用跳板机"></a>不使用跳板机</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/expect -f</span></span><br><span class="line"><span class="built_in">set</span> ip XX.XX.XX.XX</span><br><span class="line"><span class="built_in">set</span> password XXXXXXXX</span><br><span class="line"><span class="built_in">set</span> timeout 10</span><br><span class="line">spawn ssh ubuntu@<span class="variable">$ip</span></span><br><span class="line">expect &#123;</span><br><span class="line"><span class="string">"*yes/no"</span> &#123; send <span class="string">"yes\r"</span>; exp_continue&#125;</span><br><span class="line"><span class="string">"*password:"</span> &#123; send <span class="string">"<span class="variable">$password</span>\r"</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line">interact</span><br></pre></td></tr></table></figure>

<h3 id="使用跳板机"><a href="#使用跳板机" class="headerlink" title="使用跳板机"></a>使用跳板机</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/usr/bin/expect -f</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 跳板机ip password</span></span><br><span class="line">set pedalip XX.XX.XX.XX</span><br><span class="line">set pedalpw XXXXXXXX</span><br><span class="line"><span class="meta">#</span><span class="bash"> 目标机器ip password</span></span><br><span class="line">set targetip XX.XX.XX.XX</span><br><span class="line">set targetpw XXXXXXXX</span><br><span class="line">set timeout 10</span><br><span class="line">spawn ssh ubuntu@$pedalip</span><br><span class="line">expect &#123;</span><br><span class="line">"*yes/no" &#123; send "yes\r"; exp_continue&#125;</span><br><span class="line">"*password:" &#123; send "$pedalpw\r" &#125;</span><br><span class="line">&#125;</span><br><span class="line">expect "*ubuntu@*" &#123; send "ssh ubuntu@$targetip\r"&#125;</span><br><span class="line">expect &#123;</span><br><span class="line">"*yes/no" &#123; send "yes\r"; exp_continue&#125;</span><br><span class="line">"*password:" &#123; send "$targetpw\r" &#125;</span><br><span class="line">&#125;</span><br><span class="line">interact</span><br></pre></td></tr></table></figure>




      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2021/05/18/ssh-login-expect/" data-id="ckrlualr9003kxcj58c8fe1i4"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ssh%E7%99%BB%E9%99%86%E8%84%9A%E6%9C%AC/" rel="tag">ssh登陆脚本</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
    <article id="post-linux-vim-kiss" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2021/04/20/linux-vim-kiss/"
    >linux_vim_kiss</a
  >
</h2>
  

    </header>
    

    
    <div class="article-meta">
      <a href="/2021/04/20/linux-vim-kiss/" class="article-date">
  <time datetime="2021-04-20T07:31:38.000Z" itemprop="datePublished">2021-04-20</time>
</a>
      
  <div class="article-category">
    <a class="article-category-link" href="/categories/Linux/">Linux</a>
  </div>

      
      
      
    </div>
    

    

    <div class="article-entry" itemprop="articleBody">
      


      

      
      <p><a href="https://www.runoob.com/linux/linux-vim.html" target="_blank" rel="noopener">菜鸟教程vim介绍</a></p>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p><strong>上移或下移多行</strong></p>
<p>向下移动 30 行，可以使用 “30j” 或 “30↓” 的组合按键，↓表示向下键</p>
<p>向上移动 30 行，可以使用 “30k” 或 “30↑” 的组合按键，↑表示向上键 或者 30+enter</p>
<p><strong>移动到文件头部</strong></p>
<p>gg</p>
<p><strong>移动到文件尾部</strong></p>
<p>shift+g</p>
<p><strong>移动到行首</strong></p>
<p>0</p>
<p><strong>移动到行尾</strong></p>
<p>$</p>
<p><strong>移动到具体某一行</strong></p>
<p>lineNum+shift+g</p>
<p><strong>查找字符串</strong></p>
<p>/word 向光标之下寻找一个名称为 word 的字符串。例如要在档案内搜寻 vbird 这个字符串，就输入 /vbird 即可！ (常用)</p>
<p>?word  向光标之上寻找一个字符串名称为 word 的字符串。</p>
<p>n 下一个匹配的字符串</p>
<p>N 上一个匹配的字符串</p>
<p><strong>删除游标所在处一整行</strong></p>
<p>dd</p>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>TODO</p>

      
      <!-- 打赏 -->
      
    </div>
    <footer class="article-footer">
      <a data-url="https://zkdingme.github.io/2021/04/20/linux-vim-kiss/" data-id="ckrlualr7003dxcj5ekgs7f89"
        class="article-share-link">分享</a>
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/vim/" rel="tag">vim</a></li></ul>

    </footer>

  </div>

  

  
  
  

  

</article>
    
  </article>
  

  
  <nav class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul class="list-inline">
      <li>
        &copy;
        2020-2021
        Bonjour Ding
      </li>
      <li>
        
          Powered by
        
        
        <a href="https://hexo.io" target="_blank">Hexo</a> Theme <a href="https://github.com/Shen-Yu/hexo-theme-ayer" target="_blank">Ayer</a>
        
      </li>
    </ul>
    <ul class="list-inline">
      <li>
        
        
        <ul class="list-inline">
  <li>PV:<span id="busuanzi_value_page_pv"></span></li>
  <li>UV:<span id="busuanzi_value_site_uv"></span></li>
</ul>
        
      </li>
      <li>
        <!-- cnzz统计 -->
        
      </li>
    </ul>
  </div>
</footer>
    <div class="to_top">
        <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>
      </div>
    </main>
      <aside class="sidebar">
        <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/favicon.ico" alt="丁星乐"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2020/01/31/about">关于我</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="Search">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
      </aside>
      <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
      
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="https://cdn.jsdelivr.net/npm/typed.js@2.0.11/lib/typed.min.js"></script>
<script>
  var typed = new Typed("#subtitle", {
    strings: ['芒焰藏于简单之中','江山如此多娇','会当击水三千里，自信人生二百年'],
    startDelay: 0,
    typeSpeed: 200,
    loop: true,
    backSpeed: 100,
    showCursor: true
    });
</script>




<script>
  var ayerConfig = {
    mathjax: true
  }
</script>


<script src="/js/ayer.js"></script>


<script src="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/jquery-modal@0.9.2/jquery.modal.min.css">


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css">
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script>



<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
  });

  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.6/unpacked/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<script type="text/javascript" src="https://js.users.51.la/20544303.js"></script>
  </div>
</body>

</html>